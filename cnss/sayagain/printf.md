# 格式化字符串漏洞
## 0.一个坑爹的问题 
这个问题与主题没太大关系，还是提一提吧  
在ubuntu16.10后gcc编译时默认加上了参数`-pie`，也就是运行地址随机化，可以更好的抵挡攻击，防pwn，但是出题就比较坑爹了  
只需要编译时加上参数`-no-pie`即可  
## 1. 格式化字符串简介
>格式化字符串，是一些程序设计语言在格式化输出API函数中用于指定输出参数的格式与相对位置的字符串参数，例如C、C++等程序设计语言的printf类函数，其中的转换说明（conversion specification）用于把随后对应的0个或多个函数参数转换为相应的格式输出；格式化字符串中转换说明以外的其它字符原样输出。

以上摘自wiki:[格式化字符串](https://zh.wikipedia.org/wiki/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2)  
为了格式化字符串，需要使用占位符用于指明输出的参数值如何格式化。  
在c语言中的printf这一大类函数中（包括vprintf，sprintf等），使用%d,%c,%s等占位符对字符串进行格式化  
然而，一些特殊的用法往往被人们忽略了  
* 控制输出长度  
`%nx`表示按16进制输出，不足n位的话在字符串前面补空格  
`%0nx`表示按16进制输出，不足n位的话在字符串前面补空格  
其它占位符同理  
* 指定参数  
`%n$x`表示把第n个参数按16进制输出  
注：  
a. 指定参数可以与控制输出长度结合使用，如`%n$08x`  
b. 指定参数不影响正常的输出，若执行`printf("%3$d.%d.%d.%d", 1, 2, 3);`，则输出3.1.2.3  
c.在x86下指定参数时printf认为每个参数的长度为4字节，所以在碰上`long long`这样8字节或者更多的参数时，指定参数可能会出错，需要具体情况具体分析，例子见下图  

* 保存输出字符的个数
可使用%n保存输出字符的个数到变量中  
`printf("1234%n", &a)`  
由于输出了4个字符，将4写入a
注:  
a.可以与指定参数结合使用  
b.后面的参数为变量的地址，而不是变量的本身（好像是废话）  

## 2.漏洞原因
在c语言中，往往有输出字符串的场景，当输出一个字符串的一般写法为  
```C
printf("%s", str);
```
当一些程序员偷懒后就成为了  
```C
printf(str);
```
若是攻击者掌握了字符串，那么可以利用1中的特殊用法，对你的程序做一些奇怪的事情，从而pwn掉你的程序  

## 3.利用
由1可知道，%n可以写入数据，%nc等用法可以控制输出字符的长度从而控制数据的数值，结合指定参数，便可以对4字节内存进行读写  
下面以一个题为例来说明